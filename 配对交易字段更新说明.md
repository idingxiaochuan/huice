# 配对交易字段更新说明

## 背景

在回测交易系统中，当前配对交易记录的收益率计算存在问题，且缺少剩余份额的记录。我们需要：

1. 添加`remaining_shares`字段来记录卖出后剩余的份额数量
2. 将`band_profit_rate`字段更名为`sell_band_profit_rate`，用于记录卖出部分的收益率
3. 修正波段收益和收益率的计算逻辑

## 数据库表变更

在`backtest_paired_trades`表中添加了以下字段：

- `remaining_shares`: 整数类型，记录卖出后剩余的份额数量
- `sell_band_profit_rate`: 数值类型(NUMERIC(10, 4))，记录卖出部分的收益率

原有的`band_profit_rate`和`remaining`字段保留，以保持兼容性。

## 主要修改的文件

1. **backtest_gui/strategy/band_strategy.py**
   - 修正波段收益计算方法，只计算实际卖出部分的收益
   - 添加剩余份额的计算和保存
   - 添加卖出部分收益率的计算和保存

2. **backtest_gui/utils/backtest_data_manager.py**
   - 更新`save_paired_trades`方法，添加新字段
   - 更新`load_backtest_data`方法，加载新字段

3. **backtest_gui/utils/trade_query.py**
   - 更新查询SQL，包含新字段

## 新增脚本文件

1. **modify_db_schema.py**
   - 用于向数据库添加新字段

2. **update_existing_trades.py**
   - 用于更新已有的交易记录，计算正确的剩余份额和卖出部分收益率

3. **test_paired_trades.py**
   - 用于测试和验证新字段和计算逻辑

## 变更后的收益率计算方法

原来的收益率计算方法是基于总金额的：

```python
band_profit = sell_value - buy_value
band_profit_rate = (band_profit / buy_value) * 100
```

新的收益率计算方法只考虑卖出部分的金额：

```python
# 计算每份的买入价值
buy_value_per_share = buy_value / buy_amount

# 计算卖出部分的成本
sold_cost = buy_value_per_share * sell_amount

# 计算卖出部分的波段收益
band_profit = sell_value - sold_cost

# 计算卖出部分的收益率
sell_band_profit_rate = (band_profit / sold_cost) * 100
```

## 部署步骤

1. 备份数据库（重要）
2. 运行`modify_db_schema.py`添加新字段
3. 运行`update_existing_trades.py`更新已有记录
4. 运行`test_paired_trades.py`验证更改是否正确
5. 部署更新后的代码文件

## 注意事项

1. 部署前请确保已经对数据库进行备份
2. 更新代码后，请使用小部分数据进行测试，确保功能正常
3. 旧的`remaining`和`band_profit_rate`字段仍保留，以确保兼容旧的代码和查询 